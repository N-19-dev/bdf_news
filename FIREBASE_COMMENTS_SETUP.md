# Firebase Comments System Setup

This document provides instructions for setting up Firestore collections, indexes, and security rules for the commenting system.

## 1. Firestore Collections

### Collection: `comments`

This collection stores all user comments on articles.

**Document structure:**
```typescript
{
  id: string;                  // Auto-generated by Firestore
  user_id: string;             // Firebase Auth UID
  user_name: string;           // Display name
  user_photo?: string;         // Profile photo URL (optional)
  article_id: string;          // Hash of article (same as votes)
  article_url: string;         // Full article URL
  article_title: string;       // Article title
  parent_id: string | null;    // null for top-level, parent comment ID for replies
  content: string;             // Comment text (max 2000 chars)
  week_label: string;          // Week identifier (e.g., "2026w02")
  created_at: Timestamp;       // Creation timestamp
  updated_at: Timestamp;       // Last update timestamp
  is_edited: boolean;          // Whether comment was edited
  article_category: string;    // Article category key
  article_source: string;      // Article source name
  likes: number;               // Like count
}
```

### Collection: `comment_likes`

This collection tracks which users liked which comments.

**Document ID format:** `{userId}_{commentId}`

**Document structure:**
```typescript
{
  user_id: string;      // Firebase Auth UID
  comment_id: string;   // Comment document ID
  liked_at: Timestamp;  // When the like was added
}
```

### Collection: `sentiment_patterns`

This collection stores weekly sentiment analysis patterns computed by the backend.

**Document ID format:** `{type}_{key}_{week}` (e.g., `source_techcrunch_2026w02`)

**Document structure:**
```typescript
{
  pattern_type: string;         // "source_sentiment" or "category_sentiment"
  pattern_key: string;          // Source name or category key
  sentiment_score: number;      // Average sentiment (-1.0 to 1.0)
  quality_boost: number;        // Computed boost multiplier (0.8 to 1.3)
  comment_count: number;        // Total comments analyzed
  article_count: number;        // Number of articles analyzed
  applied_from_week: string;    // Week when this pattern takes effect
  computed_at: Timestamp;       // When this pattern was computed
}
```

## 2. Firestore Indexes

### Required Composite Indexes

You need to create these composite indexes in the Firebase Console:

**Go to:** Firebase Console â†’ Firestore Database â†’ Indexes â†’ Composite

#### Index 1: Comments by article (for displaying comments)
- **Collection:** `comments`
- **Fields:**
  - `article_id` (Ascending)
  - `created_at` (Ascending)
- **Query scope:** Collection

#### Index 2: Comments by week (for sentiment analysis)
- **Collection:** `comments`
- **Fields:**
  - `week_label` (Ascending)
  - `created_at` (Descending)
- **Query scope:** Collection

#### Index 3: Sentiment patterns by week
- **Collection:** `sentiment_patterns`
- **Fields:**
  - `applied_from_week` (Ascending)
  - `pattern_type` (Ascending)
- **Query scope:** Collection

### Required Single-Field Indexes

These are usually created automatically, but verify they exist:

- `comments` collection:
  - `user_id` (Ascending)
  - `parent_id` (Ascending)
  - `article_id` (Ascending)

- `comment_likes` collection:
  - `comment_id` (Ascending)
  - `user_id` (Ascending)

## 3. Firestore Security Rules

**Go to:** Firebase Console â†’ Firestore Database â†’ Rules

Replace or merge with your existing rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Comments: read all, write own
    match /comments/{commentId} {
      allow read: if true;

      // Create: user must be authenticated and provide valid data
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.user_id
        && request.resource.data.content.size() > 0
        && request.resource.data.content.size() <= 2000
        && request.resource.data.article_id is string
        && request.resource.data.week_label is string;

      // Update: only own comments, within 15 minutes
      allow update: if request.auth != null
        && request.auth.uid == resource.data.user_id
        && request.time < resource.data.created_at + duration.value(15, 'm')
        && request.resource.data.user_id == resource.data.user_id
        && request.resource.data.article_id == resource.data.article_id;

      // Delete: only own comments
      allow delete: if request.auth != null
        && request.auth.uid == resource.data.user_id;
    }

    // Comment likes: read all, write own
    match /comment_likes/{likeId} {
      allow read: if true;

      // Create/delete: user must be authenticated and like ID must match format
      allow create, delete: if request.auth != null
        && request.auth.uid == request.resource.data.user_id
        && likeId == request.auth.uid + '_' + request.resource.data.comment_id;
    }

    // Sentiment patterns: read all, write by server only
    match /sentiment_patterns/{patternId} {
      allow read: if true;
      allow write: if false;  // Only backend (via Admin SDK) can write
    }

    // Votes (existing - keep these rules)
    match /votes/{voteId} {
      allow read: if true;
      allow write: if request.auth != null
        && request.auth.uid == request.resource.data.user_id
        && voteId == request.auth.uid + '_' + request.resource.data.article_id;
    }

    // Voting patterns (existing - keep these rules)
    match /voting_patterns/{patternId} {
      allow read: if true;
      allow write: if false;  // Only backend (via Admin SDK) can write
    }
  }
}
```

## 4. Backend Configuration

Ensure the following environment variables are set in GitHub Actions:

### In `.github/workflows/backend-weekly.yml`:

Already configured:
```yaml
env:
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
```

### Required GitHub Secrets:

1. **GROQ_API_KEY** - Already exists (for LLM analysis)
2. **FIREBASE_SERVICE_ACCOUNT_KEY** - Already exists (JSON service account)

No new secrets needed!

## 5. Testing the Setup

### Test Frontend Comments:

1. Deploy the frontend to GitHub Pages
2. Log in with Google authentication
3. Navigate to any article
4. Click the ðŸ’¬ button to open comments
5. Post a test comment
6. Verify it appears in Firestore Console â†’ `comments` collection
7. Test replies (click "RÃ©pondre" on a comment)
8. Test likes (click the heart icon)
9. Test edit (click "Modifier" within 15 minutes)
10. Test delete (click "Supprimer")

### Test Backend Sentiment Analysis:

1. Post at least 3 comments on different articles during the week
2. Wait for Monday 06:00 UTC (or trigger workflow manually)
3. Check GitHub Actions logs for:
   - "Analyze comment sentiment from last week"
   - Should show number of comments analyzed
4. Verify patterns in Firestore Console â†’ `sentiment_patterns` collection
5. Check that next week's export has boosted scores

### Manual Testing (Development):

```bash
cd backend

# Test sentiment analysis (requires comments in Firestore)
WEEK_OFFSET=-1 python analyze_comment_sentiment.py

# Test relevance scoring with sentiment boosts
WEEK_OFFSET=0 python analyze_relevance.py

# Test full pipeline
WEEK_OFFSET=0 python main.py
```

## 6. Monitoring

### Check Firestore Usage:

- Firebase Console â†’ Firestore Database â†’ Usage
- Monitor read/write operations
- Check storage size

### Check GitHub Actions:

- Repository â†’ Actions â†’ Backend Weekly Export
- Verify sentiment analysis step completes successfully
- Check logs for any errors

## 7. Troubleshooting

### Comments not appearing:

1. Check browser console for JavaScript errors
2. Verify Firebase config in `.env` files
3. Check Firestore security rules (read permissions)
4. Verify indexes are created and in "Enabled" state

### Cannot post comments:

1. Verify user is authenticated
2. Check browser console for Firebase errors
3. Verify Firestore security rules (write permissions)
4. Check that required fields are present

### Sentiment analysis failing:

1. Check GitHub Actions logs
2. Verify `GROQ_API_KEY` secret is set
3. Verify `FIREBASE_SERVICE_ACCOUNT_KEY` is valid
4. Ensure at least 3 comments exist for the week
5. Check backend logs in Actions for error details

### Indexes not working:

1. Go to Firestore Console â†’ Indexes
2. Check that all required indexes are in "Enabled" state
3. If "Building" - wait (can take minutes for large datasets)
4. If "Error" - delete and recreate the index

## 8. Cost Considerations

### Firestore Operations:

- **Reads:** Each comment view = 1 read (real-time listener)
- **Writes:** Each comment/like/edit = 1 write
- **Deletes:** Each delete = 1 delete operation

### Estimated monthly costs (assuming 100 active users):

- 1000 comments/month = $0.18 writes
- 10,000 comment views = $0.36 reads
- Storage (negligible) = ~$0.01

**Total estimated cost: ~$0.55/month** (well within free tier of 50K reads, 20K writes)

### Free tier limits:

- 50,000 reads/day
- 20,000 writes/day
- 20,000 deletes/day
- 1 GB storage

## 9. Future Enhancements

Potential improvements to consider:

1. **Moderation:**
   - Add `is_flagged` field for reported comments
   - Admin interface for reviewing flagged content
   - Automatic spam detection

2. **Notifications:**
   - Email notifications for replies
   - Firebase Cloud Messaging for push notifications

3. **Rich Text:**
   - Markdown support in comments
   - Code syntax highlighting
   - Link preview embeds

4. **Analytics:**
   - Most commented articles
   - Most active commenters
   - Engagement metrics dashboard

5. **Search:**
   - Full-text search in comments
   - Filter by user or date range

## 10. Maintenance

### Weekly Tasks:

- Monitor sentiment analysis success in GitHub Actions
- Review comment quality and moderation needs
- Check Firestore usage and costs

### Monthly Tasks:

- Review security rules for any needed updates
- Analyze comment patterns and sentiment trends
- Consider archiving old comments (>6 months)

### As Needed:

- Update indexes if query patterns change
- Adjust sentiment analysis prompts for better accuracy
- Add new pattern types (e.g., keyword sentiment)
